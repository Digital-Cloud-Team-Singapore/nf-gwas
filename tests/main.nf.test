nextflow_pipeline {

    name "Test Workflow main.nf"
    script "main.nf"

    test("Should execute pipeline applying an additive model") {

        when {
            def testOutdir = outputDir
            params {
                project                       = 'gwas-additive'
                genotypes_array               = 'tests/input/pipeline/example.{bim,bed,fam}'
                genotypes_imputed             = 'tests/input/pipeline/example.vcf.gz'
                genotypes_build               = 'hg19'
                genotypes_imputed_format      = 'vcf'
                phenotypes_filename           = 'tests/input/pipeline/phenotype.txt'
                phenotypes_binary_trait       = false
                phenotypes_columns            = 'Y1,Y2'
                regenie_test                  = 'additive'
                outdir                        = "$testOutdir"
            }
        }

        then {
            assert workflow.success
            assert workflow.trace.tasks().size() == 18
            assert new File("$outputDir/results/Y1.regenie.gz").exists()
        }

    }
    test("Should execute pipeline including pruning step") {

        when {
            def testOutdir = outputDir
            params {
                project                       = "test-gwas-add-pruning"
                genotypes_array               = 'tests/input/pipeline/example.{bim,bed,fam}'
                genotypes_imputed             = 'tests/input/pipeline/example.vcf.gz'
                genotypes_build               = 'hg19'
                genotypes_imputed_format      = 'vcf'
                phenotypes_filename           = 'tests/input/pipeline/phenotype.txt'
                phenotypes_columns            = 'Y1,Y2'
                phenotypes_binary_trait       = false
                regenie_test                  = 'additive'
                prune_enabled                 = true
                outdir                        = "$testOutdir"
        }
        }

        then {
            assert workflow.success
        }

    }

    test("Should execute pipeline for binary trait with firth but without approximation") {

        when {
            def testOutdir = outputDir
            params {
                project                       = "test-gwas-binary-no-approx"
                genotypes_array               = "tests/input/pipeline/example.{bim,bed,fam}"
                genotypes_imputed             = "tests/input/pipeline/example.bgen"
                genotypes_build               = 'hg19'
                genotypes_imputed_format      = 'bgen'
                phenotypes_filename           = "tests/input/pipeline/phenotype_bin.txt"
                phenotypes_columns            = 'Y1,Y2'
                phenotypes_binary_trait       = true
                regenie_test                  = 'additive'
                regenie_firth_approx          = false
                outdir                        = "$testOutdir"
        }
        }

        then {
            assert workflow.success
        }

    }

    test("Should execute pipeline for binary trait without firth") {

        when {
            def testOutdir = outputDir
            params {
                project                       = "test-gwas-binary-no-firth"
                genotypes_array               = "tests/input/pipeline/example.{bim,bed,fam}"
                genotypes_imputed             = "tests/input/pipeline/example.bgen"
                genotypes_build               = 'hg19'
                genotypes_imputed_format      = 'bgen'
                phenotypes_filename           = "tests/input/pipeline/phenotype_bin.txt"
                phenotypes_columns            = 'Y1,Y2'
                phenotypes_binary_trait       = true
                regenie_test                  = 'additive'
                regenie_firth                 = false
                outdir                        = "$testOutdir"
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Should execute pipeline for binary traits including NAs") {

        when {
            def testOutdir = outputDir
            params {
                project                       = "test-gwas-binary-with-NA"
                genotypes_array               = "tests/input/pipeline/example.{bim,bed,fam}"
                genotypes_imputed             = "tests/input/pipeline/example.bgen"
                genotypes_build               = 'hg19'
                genotypes_imputed_format      = 'bgen'
                phenotypes_filename           = "tests/input/pipeline/phenotype_bin_wNA.txt"
                phenotypes_columns            = 'Y1,Y2'
                phenotypes_binary_trait       = true
                regenie_test                  = 'additive'
                outdir                        = "$testOutdir"
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Should execute pipeline for binary trait") {

        when {
            def testOutdir = outputDir
            params {
                project                       = "test-gwas-binary"
                genotypes_array               = "tests/input/pipeline/example.{bim,bed,fam}"
                genotypes_imputed             = "tests/input/pipeline/example.bgen"
                genotypes_build               = 'hg19'
                genotypes_imputed_format      = 'bgen'
                phenotypes_filename           = "tests/input/pipeline/phenotype_bin.txt"
                phenotypes_columns            = 'Y1,Y2'
                phenotypes_binary_trait       = true
                regenie_test                  = 'additive'
                outdir                        = "$testOutdir"
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Should execute pipeline with covariate file") {

        when {
            def testOutdir = outputDir
            params {
                project                       = 'test-gwas-covariates-file'
                genotypes_array               = 'tests/input/pipeline/example.{bim,bed,fam}'
                genotypes_imputed             = 'tests/input/pipeline/example.vcf.gz'
                genotypes_build               = 'hg19'
                genotypes_imputed_format      = 'vcf'
                phenotypes_filename           = 'tests/input/pipeline/phenotype.txt'
                phenotypes_columns            = 'Y1,Y2'
                phenotypes_binary_trait       = false
                covariates_filename           = "tests/input/pipeline/covariates.txt"
                covariates_columns            = 'V1,V2'
                regenie_test                  = 'additive'
                outdir                        = "$testOutdir"
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Should execute pipeline without missing phenotype values") {

        when {
            def testOutdir = outputDir
            params {
                project                       = 'test-gwas-delete-missing-phenotype-data'
                genotypes_array               = 'tests/input/pipeline/example.{bim,bed,fam}'
                genotypes_imputed             = 'tests/input/pipeline/example.vcf.gz'
                genotypes_build               = 'hg19'
                genotypes_imputed_format      = 'vcf'
                phenotypes_filename           = 'tests/input/pipeline/phenotype.txt'
                phenotypes_columns            = 'Y1,Y2'
                phenotypes_binary_trait       = false
                phenotypes_delete_missings    = true
                regenie_test                  = 'additive'
                outdir                        = "$testOutdir"
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Should execute pipeline applying a dominant model") {

        when {
            def testOutdir = outputDir
            params {
                project                       = 'test-gwas-dominant'
                genotypes_array               = 'tests/input/pipeline/example.{bim,bed,fam}'
                genotypes_imputed             = 'tests/input/pipeline/example.vcf.gz'
                genotypes_build               = 'hg19'
                genotypes_imputed_format      = 'vcf'
                phenotypes_filename           = 'tests/input/pipeline/phenotype.txt'
                phenotypes_binary_trait       = false
                phenotypes_columns            = 'Y1,Y2'
                regenie_test                  = 'dominant'
                outdir                        = "$testOutdir"
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Should execute pipeline with forced step1 parameter") {

        when {
            def testOutdir = outputDir
            params {
                project                       = 'test-gwas-force-step1'
                genotypes_array                = 'tests/input/pipeline/example.{bim,bed,fam}'
                genotypes_imputed             = 'tests/input/pipeline/example.vcf.gz'
                genotypes_build               = 'hg19'
                genotypes_imputed_format      = 'vcf'
                phenotypes_filename           = 'tests/input/pipeline/phenotype.txt'
                phenotypes_binary_trait       = false
                phenotypes_columns            = 'Y1,Y2'
                regenie_test                  = 'additive'
                regenie_force_step1           = 'true'
                outdir                        = "$testOutdir"
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Should execute pipeline with different header") {

        when {
            def testOutdir = outputDir
            params {
                project                       = 'test-gwas-header'
                genotypes_array               = 'tests/input/pipeline/example.{bim,bed,fam}'
                genotypes_imputed             = 'tests/input/pipeline/example.bgen'
                genotypes_build               = 'hg19'
                genotypes_imputed_format      = 'bgen'
                phenotypes_filename           = 'tests/input/pipeline/phenotype_header.txt'
                phenotypes_columns            = 'PHENO1,PHENO2'
                phenotypes_binary_trait       = false
                regenie_test                  = 'additive'
                outdir                        = "$testOutdir"
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Should execute pipeline with hg38 annotation") {

        when {
            def testOutdir = outputDir
            params {
                project                       = 'test-gwas-hg38-annotate'
                genotypes_array               = 'tests/input/pipeline/example.{bim,bed,fam}'
                genotypes_imputed             = 'tests/input/pipeline/example_hg38.vcf.gz'
                genotypes_build               = 'hg38'
                genotypes_imputed_format      = 'vcf'
                phenotypes_filename           = 'tests/input/pipeline/phenotype.txt'
                phenotypes_binary_trait       = false
                phenotypes_columns            = 'Y1,Y2'
                regenie_test                  = 'additive'
                outdir                        = "$testOutdir"
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Should execute pipeline with applied plot limit") {

        when {
            def testOutdir = outputDir
            params {
                project                       = 'test-gwas-manhattan-limit'
                genotypes_array               = 'tests/input/pipeline/example.{bim,bed,fam}'
                genotypes_imputed             = 'tests/input/pipeline/example.vcf.gz'
                genotypes_build               = 'hg19'
                genotypes_imputed_format      = 'vcf'
                phenotypes_filename           = 'tests/input/pipeline/phenotype.txt'
                phenotypes_binary_trait       = false
                phenotypes_columns            = 'Y1,Y2'
                regenie_test                  = 'additive'
                plot_ylimit                   = 2
                outdir                        = "$testOutdir"
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Should execute pipeline with tabs in phenotype file") {

        when {
            def testOutdir = outputDir
            params {
                project                       = 'test-gwas-phenotype-tabs'
                genotypes_array               = 'tests/input/pipeline/example.{bim,bed,fam}'
                genotypes_imputed             = 'tests/input/pipeline/example.vcf.gz'
                genotypes_build               = 'hg19'
                genotypes_imputed_format      = 'vcf'
                phenotypes_filename           = 'tests/input/pipeline/phenotype.tabs.txt'
                phenotypes_binary_trait       = false
                phenotypes_columns            = 'Y1,Y2'
                regenie_test                  = 'additive'
                outdir                        = "$testOutdir"
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Should execute pipeline with 3 empty phenotype values") {
        when {
            def testOutdir = outputDir
            params {
                project                       = 'test-gwas-phenotype-three-empty-values'
                genotypes_array               = 'tests/input/pipeline/example.{bim,bed,fam}'
                genotypes_imputed             = 'tests/input/pipeline/example.vcf.gz'
                genotypes_build               = 'hg19'
                genotypes_imputed_format      = 'vcf'
                phenotypes_filename           = 'tests/input/pipeline/phenotype_with_three_empty_values.txt'
                phenotypes_binary_trait       = false
                phenotypes_columns            = 'Y1,Y2'
                regenie_test                  = 'additive'
                outdir                        = "$testOutdir"
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Should execute pipeline on a specified range only") {

        when {
            def testOutdir = outputDir
            params {
                project                       = 'test-gwas-range'
                genotypes_array               = 'tests/input/pipeline/example.{bim,bed,fam}'
                genotypes_imputed             = 'tests/input/pipeline/example.vcf.gz'
                genotypes_build               = 'hg19'
                genotypes_imputed_format      = 'vcf'
                phenotypes_filename           = 'tests/input/pipeline/phenotype.txt'
                phenotypes_binary_trait       = false
                phenotypes_columns            = 'Y1,Y2'
                regenie_range                 = '1:100-200'
                regenie_test                  = 'additive'
                outdir                        = "$testOutdir"
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Should execute pipeline applying a recessive model") {

        when {
            def testOutdir = outputDir
            params {
                project                       = 'test-gwas-recessive'
                genotypes_array               = 'tests/input/pipeline/example.{bim,bed,fam}'
                genotypes_imputed             = 'tests/input/pipeline/example.vcf.gz'
                genotypes_build               = 'hg19'
                genotypes_imputed_format      = 'vcf'
                phenotypes_filename           = 'tests/input/pipeline/phenotype.txt'
                phenotypes_columns            = 'Y1,Y2'
                phenotypes_binary_trait       = false
                regenie_test                  = 'recessive'
                outdir                        = "$testOutdir"
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Should execute pipeline without regenie predictions") {

        when {
            def testOutdir = outputDir
            params {
                project                       = 'test-gwas-skip-predictions'
                genotypes_array               = 'tests/input/pipeline/example.{bim,bed,fam}'
                genotypes_imputed             = 'tests/input/pipeline/example.vcf.gz'
                genotypes_build               = 'hg19'
                genotypes_imputed_format      = 'vcf'
                phenotypes_filename           = 'tests/input/pipeline/phenotype.txt'
                phenotypes_columns            = 'Y1,Y2'
                phenotypes_binary_trait       = false
                regenie_skip_predictions      = true
                regenie_test                  = 'additive'
                outdir                        = "$testOutdir"
            }
        }

        then {
            assert workflow.success
        }

    }

}
